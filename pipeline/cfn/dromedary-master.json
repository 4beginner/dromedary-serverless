{
  "AWSTemplateFormatVersion":"2010-09-09",
  "Description":"Master dromedary stack that calls nested stacks",
  "Parameters":{
    "BaseTemplateURL":{
      "Type":"String",
      "Description":"S3 Base URL of all the CloudFormation templated used in Dromedary (without the file names)"
    },
    "CodePipelineTemplateURL":{
      "Type":"String",
      "Description":"Just the name of the CloudFormation template. Used with BaseTemplateURL.",
      "Default":"codepipeline-cfn.json"
    },
    "CodePipelineActionsTemplateURL":{
      "Type":"String",
      "Description":"Just the name of the CloudFormation template. Used with BaseTemplateURL.",
      "Default":"codepipeline-custom-actions.json"
    },
    "IAMTemplateURL":{
      "Type":"String",
      "Description":"Just the name of the CloudFormation template. Used with BaseTemplateURL.",
      "Default":"iam.json"
    },
    "S3TemplateURL":{
      "Type":"String",
      "Description":"Just the name of the CloudFormation template. Used with BaseTemplateURL.",
      "Default":"s3.json"
    },
    "DDBTemplateURL":{
      "Type":"String",
      "Description":"Just the name of the CloudFormation template. Used with BaseTemplateURL.",
      "Default":"dynamodb.json"
    },
    "DDBTableName":{
      "Type":"String",
      "Description":"Unique name for the Dromedary Dynamo DB table"
    },
    "BucketPrefix":{
      "Type":"String",
      "Description":"The prefix to use for stage bucket names for static content",
      "Default":"dromedary"
    },
    "DromedaryRepo":{
      "Type":"String",
      "Description":"The Github https address to the public dromedary repository.",
      "Default":"https://github.com/stelligent/dromedary.git"
    },
    "Branch":{
      "Type":"String",
      "Description":"The Github branch the public dromedary repository.",
      "Default":"master"
    }
  },
  "Resources":{
    "DynamoDBStack":{
      "Type":"AWS::CloudFormation::Stack",
      "Properties":{
        "TemplateURL":{
          "Fn::Join":[
            "",
            [
              {
                "Ref":"BaseTemplateURL"
              },
              {
                "Ref":"DDBTemplateURL"
              }
            ]
          ]
        },
        "TimeoutInMinutes":"60",
        "Parameters":{
          "DDBTableName":{
            "Ref":"DDBTableName"
          }
        }
      }
    },
    "S3Stack":{
      "Type":"AWS::CloudFormation::Stack",
      "Properties":{
        "TemplateURL":{
          "Fn::Join":[
            "",
            [
              {
                "Ref":"BaseTemplateURL"
              },
              {
                "Ref":"S3TemplateURL"
              }
            ]
          ]
        },
        "TimeoutInMinutes":"60",
        "Parameters":{
          "BucketPrefix":{
            "Ref":"BucketPrefix"
          }
        }
      }
    },
    "IAMStack":{
      "Type":"AWS::CloudFormation::Stack",
      "Properties":{
        "TemplateURL":{
          "Fn::Join":[
            "",
            [
              {
                "Ref":"BaseTemplateURL"
              },
              {
                "Ref":"IAMTemplateURL"
              }
            ]
          ]
        },
        "TimeoutInMinutes":"60",
        "Parameters":{
          "DDBTableName":{
            "Ref":"DDBTableName"
          }
        }
      }
    }
  },
  "Outputs":{
    "StackName": {
      "Value": { "Ref": "AWS::StackName" }
    },
    "AcceptanceURL" : {
      "Value" : { "Fn::GetAtt" : [ "S3Stack", "Outputs.AcptURL" ] } ,
      "Description" : "Acceptance URL"
    },
    "ExploratoryURL" : {
      "Value" : { "Fn::GetAtt" : [ "S3Stack", "Outputs.ExpURL" ] } ,
      "Description" : "Exploratory URL"
    },
    "ProductionURL" : {
      "Value" : { "Fn::GetAtt" : [ "S3Stack", "Outputs.ProdURL" ] } ,
      "Description" : "Production URL"
    }
  }
}